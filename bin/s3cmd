#!/usr/bin/env ruby 

$:.unshift(File.dirname(__FILE__) + '/../lib') unless $:.include?(File.dirname(__FILE__) + '/../lib')

require "s3sync/exceptions"
require "s3sync/config"
require "s3sync/cmd"

conf = S3sync::Config.new

# Time to load config and see if we've got everything we need to cook our salad
begin
  conf.read
rescue S3sync::NoConfigFound => exc
  # We can't proceed without having those two vars set
  if not (conf.has_key? "AWS_ACCESS_KEY_ID" and conf.has_key? "AWS_SECRET_ACCESS_KEY")
    $stderr.puts "You didn't set up your environment variables :("
    $stderr.puts "I tried the following paths:"
    exc.paths_checked.each {|path| $stderr.puts " * #{path}/s3config.yml"}

    $stderr.puts "You could try to set the `S3CONF' environment variable."
    $stderr.puts "Learn how to do that here: https://github.com/clarete/s3sync"
    exit
  end
end


# Step aside, the star of this show is here. Let's try to create the
# environment to run the requested command. And feed the user back if
# information needed was not enough
begin
  S3sync::Cmd.new(conf)
rescue S3sync::WrongUsage => exc
  name = $0.split('/').last

  $stderr.puts <<"ENDUSAGE"
Usage: #{name} [options] <command> [arg(s)]

Options:
  -h, --help
  -v, --verbose
  -n, --dryrun
  -s, --ssl
  -d, --debug
      --progress
      --expires-in=(<# of seconds> | [#d|#h|#m|#s])

Commands:
  #{name} listbuckets
  #{name} createbucket <bucket>
  #{name} deletebucket <bucket>
  #{name} list <bucket>[:prefix]
  #{name} location <bucket>
  #{name} delete <bucket>:<key>
  #{name} deleteall <bucket>[:prefix]
  #{name} get|put <bucket>:<key> <file>
ENDUSAGE

  $stderr.puts "\nCurrent error:\n  #{exc.msg}\n" if exc.msg
  exit exc.error_code
end
